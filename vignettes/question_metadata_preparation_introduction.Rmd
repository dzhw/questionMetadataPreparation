---
title: "Introduction to preparing question metadata for the MDM"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to preparing question metadata for the MDM}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

The R library questionMetadataPreparation serves as the set of tools to prepare
question metadata in a format suitable for https://metadata.fdz.dzhw.eu.

The destination format is called *mdm*, which consists of question-JSONs, 
question-images (in png format) and, question-image-jsons. In order to generate 
metadata in this format, one first needs to work in the *handcrafted* format.
The *handcrafted* format consists of an excel file and possibly question-image files. If the study was conducted with the DZHW's online survey application 
*zofar*, they can be transformed to the *handcrafted* format. It is planned to 
implement conversion routines from other survey tools to the *handcrafted* 
format.

# Workflow

In the following we'll describe the workflow in a first step from  
*handcrafted* format to the *mdm* format because this step will always be performed. Afterwards we will explain how to arrive at the *mdm* format from metadata in the *zofar* format.

# manually/ handcrafted question metadata

In order to generate question metadata in the *mdm* format, you first need to 
fill an excel spreadsheet. The excel spreadsheet contains two sheets: questions 
and images. You find the column names and the directions to fill the sheet 
correctly in the next subsection.

In addition, each question can have one or more images -- however it is not 
mandatory anymore to have images. 
A tutorial to extract question images from ragtime files can be found [here](https://metadatamanagement.readthedocs.io/de/latest/bilderfassung_ragtime.html).
If you need to extract question images from pdfs, you find the tutorial
[here](https://metadatamanagement.readthedocs.io/de/latest/bilderfassung_pdf.html).

## Excel-spreadsheet

In order to use the convert_handcrafted_questionnaires_to_mdm_format function,
you need to fill in the file *questions.xlsx*, which contains the sheets 
*questions* and *images*. You can enter all questions from all instruments in a 
single excel file.

How to fill in the excel sheet "questions"

+------------------------+-----------------------+------------------------+
| **Sheet 1: questions**                                                  |
+========================+=======================+========================+
| You can enter more than|                       |                        |
| one questions, one per |                       |                        |
| row                    |                       |                        |
+------------------------+-----------------------+------------------------+
| **Columnheading**      | **Mandatory**         | **What needs to be     |
|                        |                       |entered?**              |
+------------------------+-----------------------+------------------------+
| indexInInstrument      | yes                   | Number of the question |
|                        |                       | in the questionnaire,  |
|                        |                       | which specifies the    |
|                        |                       | order (integer)        |
+------------------------+-----------------------+------------------------+
| questionNumber         | yes                   | Questionnumber,        |
|                        |                       | ideally self           |
|                        |                       | explanatory; derived   |
|                        |                       | from the instrument    |
|                        |                       | (e.g. 1.1              |
|                        |                       | 1.1). Format: 0-9,     |
|                        |                       | a-z, umlauts, ß, ., -  |
+------------------------+-----------------------+------------------------+
| instrumentNumber       | yes                   | Number of the          |
|                        |                       | instrument             |
+------------------------+-----------------------+------------------------+
| successorNumbers       | no                    | questionNumbers of the |
|                        |                       | following question(s)  |
|                        |                       | (one row, comma        |
|                        |                       | separated)             |
+------------------------+-----------------------+------------------------+
| questionsText.de/en    | yes                   | „Overarching“          |
|                        |                       | question text if       |
|                        |                       | there's a battery of   |
|                        |                       | items; introducing     |
|                        |                       | question text in case  |
|                        |                       | of complex questions.  |
|                        |                       | The complete question  |
|                        |                       | text for simple        |
|                        |                       | questions.             |
+------------------------+-----------------------+------------------------+
| instruction.de/en      | no                    | If available, statement|
|                        |                       | text of the question   |
+------------------------+-----------------------+------------------------+
| introduction.de/en     | no                    | If available,          |
|                        |                       | introductory text of   |
|                        |                       | the question           |
+------------------------+-----------------------+------------------------+
| type.de/en             | yes                   | de: „Einfachnennung“,  |
|                        |                       | „Offen“,               |
|                        |                       | „Mehrfachnennung“,     |
|                        |                       | „Itembatterie“ oder    |
|                        |                       | „Matrix“ (a manual of  |
|                        |                       | the different types    |
|                        |                       | can be found           |
|                        |                       | [here][typelink])      |
|                        |                       |                        |
|                        |                       | en: „Single Choice“,   |
|                        |                       | „Open“, „Multiple      |
|                        |                       | Choice“, „Item Set“    |
|                        |                       | or „Grid“.             |
+------------------------+-----------------------+------------------------+
| topic.de/en            | no                    | Theme block in which   |
|                        |                       | the question is        |
|                        |                       | arranged in the        |
|                        |                       | instrument (ideally, it| 
|                        |                       | can be taken directly  |
|                        |                       | from the instrument).  |
+------------------------+-----------------------+------------------------+
| technicalRepresentati\ | x\*                   | Origin of the code     |
| ion                    |                       | snippet (e.g. "ZOFAR-\ |
|                        |                       | Question Markup        |
|                        |                       | Language")             |
+------------------------+-----------------------+------------------------+
| technicalRepresentati  | x\*                   | Technical language of  |
| on.language            |                       | the code snippet       |
|                        |                       | (e.g. XML)             |
+------------------------+-----------------------+------------------------+
| technicalRepresentati\ | x\*                   | Code snippet to        |
| on.source              |                       | technically map        |
|                        |                       | questions              |
|                        |                       | (e.g. QML-snippet)     |
+------------------------+-----------------------+------------------------+
| additionalQuestionTex\ | no                    | Further explanations of|
| t.de/.en               |                       | the question that are  |
|                        |                       | not in the question    |
|                        |                       | text, such as the item |
|                        |                       | text (for item         |
|                        |                       | batteries) or answer   |
|                        |                       | text (for multiple     |
|                        |                       | answers). Currently,   |
|                        |                       | this information is not|
|                        |                       | visible to the user of |
|                        |                       | the MDM, but is only   |
|                        |                       | considered in a full   |
|                        |                       | text search.           |
+------------------------+-----------------------+------------------------+
| annotations.de/en      | no                    | Comments on the        |
|                        |                       | question               |
+------------------------+-----------------------+------------------------+
| conceptIds             | no                    | List of IDs of concepts|
|                        |                       | in the MDM (comma      |
|                        |                       | separated on one line  |
+------------------------+-----------------------+------------------------+

[typelink]: https://github.com/dzhw/metadatamanagement/files/1421895/Anleitung_Vergabe_Fragetypen.docx

x\* = mandatory only, if technicalRepresentation present (it's provided by 
zofar)

You need to fill the images spreadsheet only if there are images. 
However, the columns need to be present always. 

+------------------------+----------------------+-----------------------+
| **Excel sheet   2:                                                    |
| images**                                                              |
+========================+======================+=======================+
| You can enter more than                                               |
| one image, one image                                                  |
| per row                                                               |
+------------------------+----------------------+-----------------------+
| **Columnheading**      | **Is it mandatory?   | **What do I need to \ |
|                        |                      | fill in?**            |
+------------------------+----------------------+-----------------------+
| fileName               | yes                  | File name of the image|
|                        |                      | (e.g. "1.1_1.png") The|
|                        |                      | image is then expected|
|                        |                      | in "./Bilder/png/ins" |
|                        |                      |+ "{instrumentNumber}/"|
+------------------------+----------------------+-----------------------+
| questionNumber         | yes                  | Question number       |
|                        |                      | assigned to the image |
+------------------------+----------------------+-----------------------+
| instrumentNumber       | yes                  | Number of the         |
|                        |                      | instrument belonging  |
|                        |                      | to the image          |
+------------------------+----------------------+-----------------------+
| language               | yes                  | Language of the image |
|                        |                      |                       |
|                        |                      | *Please abbreviate    |
|                        |                      | according to          |
|                        |                      | ISO 639-1_*:          |
|                        |                      | e.g. „de“, „en“       |
+------------------------+----------------------+-----------------------+
| indexInQuestion        | yes                  | How many pictures of  |
|                        |                      | the question does the |
|                        |                      | line refer to? (If    |
|                        |                      | there is only one     |
|                        |                      | picture per question, |
|                        |                      | this is always 1)     |
+------------------------+----------------------+-----------------------+
| resolution.widthX      | no                   | Resolution of the     |
|                        |                      | image in pixels       |
+------------------------+----------------------+-----------------------+
| resolution.heightY     | no                   | Resolution of the     | 
|                        |                      | image in pixels       | 
+------------------------+----------------------+-----------------------+

.. _639-1: https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes

In case you have question images, you need to fill the second sheet of the excel 
file. The images have to be PNG files and need to be put in the subdirectory
"./Bilder/png/ins{instrumentNumber}".

The files need to be stored as follows:

```
|--questions
  |--questions*.xlsx (two sheets, questions and images)
  |--Bilder
    |--png
      |--ins1
        |--5_1.png (must match the filename in the images excel sheet)
        |--5_2.png (must match the filename in the images excel sheet)
      |--ins2
        |--5_1.png (must match the filename in the images excel sheet)
        |--5_2.png (must match the filename in the images excel sheet)
```


## Generating the mdm format JSON and images files using R

As mentioned above, you need to have R installed (at least version 3.6.1).
You find the documentation for installing the R package 
[here](https://dzhw.github.io/questionMetadataPreparation/).

Then you need to load the R package using the following command:

```{r}
library(questionMetadataPreparation)
```

If all necessary files are stored according to this tutorial, you just need to
specify the input directory:

```{r, eval = FALSE}
convert_handcrafted_questionnaires_to_mdm_format(input_directory = "./questions")
```

You could also specify an output directory:

```{r, eval = FALSE}
convert_handcrafted_questionnaires_to_mdm_format(input_directory = "./questions", output_directory = "./output/questions")
```

And if you'd like to specify it as well, you can specify the images directory as 
well:

```{r, eval = FALSE}
convert_handcrafted_questionnaires_to_mdm_format(input_directory = "./questions", output_directory = "./output/questions", images_subdirectory = "Bilder/png")
```


# Questions (Zofar)

If the data was collected using DZHW's online questionnaire tool zofar, the 
metadata (JSONs and pngs) can be extracted automatically. However, they need to 
be translated to the *handcrafted* format first. After the conversion, they need
to be adapted, because zofar cannot extract all necessary information.

In order to convert the metadata from the *zofar* format to the *handcrafted* 
format, you need to use the data provided in the *pages* directory, not the data in the *questions* directory and then run the following function:

```{r, eval = FALSE}
convert_zofar_export_to_handcrafted_questionnaire(input_directory = "./ins1", output_directory = "./handcrafted/questions")
```

You just need to specify the input_directory parameter and if you'd like the 
output_directory parameter. Afterwards, call the function 
convert_handcrafted_questionnaires_to_mdm_format as explained above.

